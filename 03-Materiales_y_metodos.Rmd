# Materiales y métodos {-}

----

Se analizaron tres bases de datos tipo phyloseq bajo el enfoque de las redes multicapa. La primera de estas contenía datos de la microbiota del escarabajo Lema daturaphila y de la microbiota de la planta de la cual este se alimenta durante su estadio larval, la solanácea Datura inoxia [@mayoral2020extended]. También se analizaron dos bases de datos procedentes del paquete seqtime [@seqtime], correspondientes a series temporales de la microbiota de dos sujetos; el primero de los cuales (sujeto A) realizó un viaje entre los días 71 y 122 durante los cuales cambió su régimen alimenticio, sufriendo en consecuencia dos episodios de diarrea entre los días 80 a 85 y 104 a 113. Por su parte, el sujeto B experimentó una intoxicación por *Salmonella* entre los días 151 y 159 [@David2014].

Para la realización de este trabajo se utilizó la versión 4.1.0 (2021-05-18) de R. Se emplearon los paquetes *igraph* [@igraph], *phyloseq* [@phyloseq], *SpiecEasi* [@SpiecEasi], *minet* [@minet], *seqtime* [@seqtime], *muxViz* [@muxViz], *multinet* [@multinet], *corrplot* [@corrplot2021] y *BiodiversityR* [@BiodiversityR]. Algunos de los paquetes están disponibles en CRAN y otros fueron descargados de repositorios de GitHub o del proyecto para análisis de datos genómicos Bioconductor.

Paquete | Uso | Fuente | Descarga
--------|-----|--------|---------
igraph | Construcción, diseño, análisis y manipulación de redes. | CRAN | install.packages("igraph")
phyloseq | Herramientas para la importación, análisis, almacenamiento y la visualización de datos de microbioma. | Bioconductor | if(!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager"); BiocManager::install("phyloseq")
devtools | Provee las funciones necesarias para el desarrollo de paquetes de R y descarga desde repositorios GitHub. | CRAN | install.packages("devtools")
SpiecEasi | Estimación de la covarianza de datos de abundancia e inferencia de redes ecológicas. | GitHub | library(devtools); install_github("zdk123/SpiecEasi")
seqtime | Provee datos de series temporales de microbiota, y herramientas para simular y analizar la dinámica de comunidades microbianas en el tiempo. | GitHub | library(devtools); install_github("hallucigenia-  sparsa/seqtime")
muxViz | Construcción, diseño y análisis de redes multicapa. | GitHub | devtools::install_github("manlius/muxViz")
multinet | Construcción, diseño y análisis de redes multicapa. | CRAN | install.packages("multinet")
corrplot | Análisis de la correlación de matrices. | CRAN | install.packages("corrplot")
BiodiversityR | Análisis de diversidad | CRAN | install.packages("BiodiversityR")

![**Tabla 1:** Paquetes de R utilizados.]()

También  desarrollé  una serie de funciones en R que me permitieron analizar los datos, mismas que fueron almacenadas como un paquete de autoría propia que llamamos **ml_BioNets**. Dicho paquete depende de *igraph* [@igraph], *muxViz* [@muxViz] y *phyloseq* [@phyloseq].

Comando | Uso | Inputs 
--------|-----|--------
T_collapse(T_table, O_table, names_level) | Suma las abundancias absolutas de los OTUs pertenecientes a cada uno de los clados del nivel taxonómico seleccionado. | Tabla de taxones, tabla de OTUs y nivel taxonómico.
v_colored(g, T_table, g_tax, p_tax, g_colors) | Colorea los nodos en función del nivel taxonómico seleccionado. El resultado se almacena como un atributo asociado a los nodos al que llamamos *color*. | Red tipo igraph, tabla de taxones, nivel taxonómico superior, nivel taxonómico en el cual se infirió la red, y un carácter que contenga los colores que se asignados a cada clado.
g_abundance(layer_mat, g) | Colorea los nodos en función de su abundancia relativa. El resultado se almacena como un atributo asociado a los nodos al que llamamos *rel_ab*. | Matriz de abundancias de la capa y la red de la capa.
TaxGroup(g, T_table, g_tax, p_tax) | Indica a qué clado, de la categoría taxonómica seleccionada, pertenece un determinado grupo de nodos. El resultado se almacena como un atributo asociado a los nodos al que llamamos *Taxon*. | Red tipo igraph, tabla de taxones, nivel taxonómico superior, y nivel taxonómico en el cual se infirió la red.
ctr(g.list, ctr_type) | Colorea los nodos en un espectro de colores cálidos en función de su centralidad por grado, intermediación o cercanía. El resultado se almacena como un atributo asociado a los nodos al que llamamos *hl*. | Objeto muxViz y tipo de centralidad seleccionada (*degree*, *betweenness* o *closeness*).
ctr_g(g, ctr_type) | Colorea los nodos en un espectro de colores cálidos en función de su centralidad por grado, intermediación o cercanía. El resultado se almacena como un atributo asociado a los nodos al que llamamos *hl*. | Red tipo igraph y tipo de centralidad seleccionada (*degree*, *betweenness* o *closeness*).
diff_nodes_graph(T_Collapsed, n, mat_list, g.list, alpha) | Identifica diferencias significativas entre la media de las abundancias de nodos réplica en redes bipartitas. Esta función sólo considera los nodos con mayor abundancia. El resultado se almacena como un atributo asociado a los nodos al que llamamos *colorA*. | Tabla de abundancias de todas las muestras, número a nodos a considerar, lista de matrices de abundancias de las distintas capas, y el nivel de significancia alfa.
corr_clusters(clusters, method, as.corrplot) | Esta función permite generar una matriz de correlaciones de la clusterización entre las capas de la red, además de un gráfico de correlaciones. | Lista de objetos tipo *communities* para cada capa, generados con alguna de las funciones de clusterización de *igraph*. Los métodos de comparación de la clusterización entre capas pueden ser "*vi*", "*nmi*", "*split.join*". "*rand*" o "*adjusted.rand*". Si *as.corrplot = T*, la función genera un gráfico de correlaciones, de lo contrario arroja una matriz de correlaciones.

![**Tabla 2:** Funciones del paquete ml_BioNets.]()

Previo a la inferencia de las redes, se colapsaron los datos a nivel de género en todas las bases de datos, eliminando previamente todos aquellos no-clasificados. Para esto se construyó la función *T_Collapse()*, que emplea como entrada la tabla de OTUs, la tabla de taxones y el nivel taxonómico hasta el cual se desea colapsar los datos. Dicha función suma las abundancias absolutas de los OTUs pertenecientes a cada uno de los clados dentro de la categoría taxonómica seleccionada.

Para inferir las redes se emplearon como datos de entrada una tabla de OTUs, que contiene las abundancias relativas de los OTUs en las muestras, y una tabla de taxones, misma que contiene la clasificación taxonómica de los OTUs. Para generar las redes multicapa previamente se separaron los datos concernientes a cada una de las capas. Para el caso de la red planta-insecto se separaron los datos correspondientes al escarabajo (huevos, intestino y excremento) y aquellos pertenecientes a la solanácea (endófitos, epifitos y semillas). Para los datos de series temporales, se separaron los períodos de salud y de enfermedad. Se aislaron tres secciones distintas de los datos del sujeto A, tomando en cuenta el periodo previo al viaje, durante el viaje y después del viaje. No fue posible construir redes únicamente a partir de los datos de los dos periodos de diarrea durante el viaje, debido a que el número de muestra era demasiado bajo como para que cualquiera de los algoritmos posteriormente utilizados pudiese inferir correlaciones entre los nodos. Para el sujeto B se tomó en cuenta el periodo previo a la infección por *Salmonella*, el periodo durante el cual se desarrolló la infección, y el periodo posterior a esta.

Posteriormente se procedió a la inferencia de las redes para cada una de las capas, para lo cual se emplearon los algoritmos SparCC del paquete SpiecEasi [@SpiecEasi] y ARACNe del paquete minet [@minet]. Para el caso del algoritmo SparCC, se eliminaron todas las correlaciones por debajo de un umbral de 0.4. Inicialmente se planteó utilizar también el algoritmo SPIEC-EASI, pero debido a su alta selectividad, no fue posible construir redes para algunas de las capas con bajos números de muestra, razón por lo cual su uso se descartó. Se analizó también la diversidad de las distintas capas mediante los índices de Shannon y Simpson, además de la abundancia relativa de los *phyla* en las capas. Se empleó el índice de diversidad de Rényi, también conocido como entropía de Rényi, mismo que cuantifica la insertidumbre del sistema en base al número de taxones y sus abundancias absolutas [@tothmeresz1995comparison].

Para visualizar la distribución de los *phyla* en la red se generó la función v_colored(), que asigna un color a todos los nodos que pertenezcan a un mismo filo. Se construyó la función g_abundance() con el fin de visualizar los nodos de la red en función de su abundancia relativa. Para analizar las características de la red también se analizó la distribución del *degree* de las capas con una prueba de Shapiro-Wilk, y se comparó la distribución del *degree* entre las capas.

El análisis de *clusters* se realizó por el método *Louvain*, mismo que optimiza la modularidad para detectar comunidades de nodos muy interconectados mediante el cálculo la densidad de aristas dentro de la red, cuyos valores pueden variar entre 1 y -1 [@combe2015louvain]. También se emplearon como complemento los métodos *optimal* y *fast-greedy*, para analizar la conservación de las comunidades encontradas bajo distintos algoritmos [@de2011generalized]. El primero maximiza la modularidad de todas las particiones posibles para calcular la estructura óptima de las comunidades del grafo [@klein1991optimal], mientras que el segundo busca regiones con alta densidad de nodos y aristas en el grafo [@kazakovtsev2014genetic]. Se analizó la similaridad de los *clusters* de las capas mediante el índice Rand, cuyo valor varía entre 0 y 1, y que toma en cuenta todos los pares de nodos posibles presentes y no presentes en el mismo *cluster* en dos comunidades distintas, como ratio del número de pares desordenados posibles [@yeung2001details]. También se utilizó el coeficiente NMI (*Normalized Mutual Information*), cuyo valor también oscila entre 0 y 1, que calcula la información compartida entre *clusters* en función de los elementos compartidos, y considerando además la entropía como el número de clases de elementos distintos contenidos en un *cluster* [@ana2003robust].

![**Figura 24:** Clusterización mediante el método *Louvain* de las capas de la red escarabajo-solanácea. Los *clusters* corresponden a regiones de la red ampliamente interconectadas. Las aristas que conectan los nodos dentro de la comunidad están representadas en negro, mientras que aquellas que conectan nodos entre comunidades distintas resaltan en rojo. Para facilitar la visualización de las comunidades se eliminaron los nodos cuyo *degree* fuese nulo.](https://raw.githubusercontent.com/Nertekkad/ml_nets/main/Images/Fig24.PNG)

Se construyeron las redes multicapa utilizando el paquete *muxViz*. La red escarabajo-solanácea se analizó bajo el enfoque de las redes multiplex, mientras que las redes de los sujetos A y B se analizaron como redes temporales. Se compararon los nodos de las comunidades entre las capas, para lo cual se utilizó la función TaxGruop(), que nos permitió identificar el *phylum*, clase y familia a la que pertenecen los conjuntos de nodos clusterizados.

Se analizó la relevancia de los nodos de las comunidades mediante distintas medidas de centralidad, para lo cual se construyeron las funciones ctr() y ctr_g() para redes multicapa y las redes simples, respectivamente. Solo se consideraron las centralidades por *degree* e intermediación, debido a que la centralidad por cercanía no se definió correctamente ante la existencia de nodos y comunidades aisladas. Se identificaron nodos réplica con y sin diferencias significativas entre pares de capas mediante una prueba de t-Student (p<0.05). Únicamente se consideraron los 20 nodos con mayor abundancia dentro de las muestras. Finalmente, mediante el paquete *multinet* [@multinet] se analizó la correlación entre capas con respecto a los nodos, el *degree* y las conexiones en las redes temporales de los sujetos A y B.
